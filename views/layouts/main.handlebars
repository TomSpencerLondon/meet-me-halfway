<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #floating-panel {
      position: absolute;
      top: 10px;
      left: 25%;
      z-index: 5;
      background-color: #fff;
      padding: 5px;
      border: 1px solid #999;
      text-align: center;
      font-family: 'Roboto', 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }
  </style>
  <!-- References a Handlebars partial in views/partials/head.handlebars -->
  {{>head}}

  <title>Meet Me Halfway</title>
</head>

<body>

<!-- References a Handlebars partial in views/partials/bsnavbar.handlebars -->
{{>bsnavbar}}

<!-- The HTML for each view goes here -->
<div class="container">
  <img src="http://www.halfway-app.com/blog/wp-content/uploads/2016/07/halfway-logo549x136.png" width=230>
{{{body}}}
</div>

<div id="floating-panel">
    <input id="address" type="textbox" value="">
    <input id="address2" type="textbox" value="">
    <input id="submit" type="button" value="Geocode">
  </div>
  <div id="map"></div>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script>
      var halfWayPointLat = 0;
      var halfWayPointLng = 0;

    function parseUsersLocation() {
      fetch("http://ip-api.com/json").then(res => res.json()).then((out) => {

        initMap(out);
      }).catch(err => {
        throw err
      });

      function initMap(currentLocation) {

        console.log(currentLocation["lat"], currentLocation["lon"]);

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: {
            lat: currentLocation["lat"],
            lng: currentLocation["lon"]
          }
        });

        var geocoder = new google.maps.Geocoder();

        function onSubmit() {

          function onComplete(pos1,pos2){
            let pos = { lat: (pos1.lat + pos2.lat) / 2, lng: (pos1.lng + pos2.lng) / 2 };

            console.log("Mid point: ", JSON.stringify(pos));

            let marker = new google.maps.Marker({
              map: map,
              position: pos
            });

            map.setCenter(pos);
          };

          geocodeAddress(geocoder, map, 'address').then( (resultPos1) => {
            geocodeAddress(geocoder, map, 'address2').then( (resultPos2) =>
              onComplete(resultPos1, resultPos2) ).catch(errorStr =>
               alert(errorStr))
          }).catch(errorStr => alert(errorStr));

        };

        document.getElementById('submit').addEventListener('click', onSubmit);
      }

      function geocodeAddress(geocoder, resultsMap, element) {
        return new Promise(function(resolve, reject){

          var address = document.getElementById(element).value;

          geocoder.geocode({
            'address': address
          }, function (results, status) {
            if (status === 'OK') {
              console.log(results);

              var pos = {lat: results[0].geometry.location.lat(),
                         lng: results[0].geometry.location.lng()};

              resolve(pos);

              var marker = new google.maps.Marker({
                map: resultsMap,
                position: results[0].geometry.location
              });
            } else {
              reject('Geocode was not successful for the following reason: ' + status);
            }
          });
        })
      }
    }


  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzf3_dclSEPO7zAq7LW8IaJPyAtnyGrqo
    &callback=parseUsersLocation">
  </script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>


</body>
</html>
